<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CryptoCurrencyPriceUpdateTask.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">capstone</a> &gt; <a href="index.source.html" class="el_package">com.usyd.capstone.common.compents</a> &gt; <span class="el_source">CryptoCurrencyPriceUpdateTask.java</span></div><h1>CryptoCurrencyPriceUpdateTask.java</h1><pre class="source lang-java linenums">package com.usyd.capstone.common.compents;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.usyd.capstone.common.DTO.CryptoCurrencyInfo;
import com.usyd.capstone.common.Enums.CATEGORY;
import com.usyd.capstone.common.Enums.CryptoCurrencyType;
import com.usyd.capstone.common.Enums.SYSTEM_SECURITY_KEY;
import com.usyd.capstone.entity.PriceThreshold;
import com.usyd.capstone.entity.Product;
import com.usyd.capstone.entity.ProductPriceRecord;
import com.usyd.capstone.mapper.ProductPriceRecordMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.scheduling.annotation.Async;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import javax.annotation.PostConstruct;
import java.util.*;

@Component
<span class="fc" id="L26">public class CryptoCurrencyPriceUpdateTask extends BaseTask {</span>


    @Autowired
    private RestTemplate restTemplate;

<span class="fc" id="L32">    private String apiUrl = &quot;https://data.mifengcha.com/api/v3/price?slug=&quot;;</span>

    @PostConstruct
    public void CryptoCurrencyPriceUpdateTask()
    {
<span class="fc" id="L37">        category = CATEGORY.CRYPTOCURRENCY;</span>
<span class="fc" id="L38">        initProductMap();</span>
<span class="fc" id="L39">    }</span>

    @Async
//    @Scheduled(fixedRate = 1800000) // 每半小时执行一次，单位为毫秒
    public void updateCurrencyRates() {

<span class="nc" id="L45">        StringBuilder cryptocurrencyNames = new StringBuilder();</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (!productMap.isEmpty()){</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">            for(Map.Entry&lt;String, Product&gt; entry : productMap.entrySet())</span>
            {
<span class="nc" id="L49">                cryptocurrencyNames.append(entry.getKey()).append(&quot;,&quot;);</span>
<span class="nc" id="L50">            }</span>
        }else {
            // 枚举获得需要拉取的值
<span class="nc" id="L53">            CryptoCurrencyType[] currencies = CryptoCurrencyType.values();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            for (CryptoCurrencyType currency : currencies) {</span>
<span class="nc" id="L55">                cryptocurrencyNames.append(currency).append(&quot;,&quot;);</span>
            }
        }

<span class="nc" id="L59">        cryptocurrencyNames.deleteCharAt(cryptocurrencyNames.length() - 1);</span>
<span class="nc" id="L60">        String cryptoCurrencyPriceUrl = apiUrl + cryptocurrencyNames + &quot;&amp;api_key=&quot; + SYSTEM_SECURITY_KEY.CRYPTO_CURRENCY_API_KEY.getValue();</span>
<span class="nc" id="L61">        ResponseEntity&lt;List&lt;CryptoCurrencyInfo&gt;&gt; response = restTemplate.exchange(</span>
                cryptoCurrencyPriceUrl,
                HttpMethod.GET,
                null,
<span class="nc" id="L65">                new ParameterizedTypeReference&lt;List&lt;CryptoCurrencyInfo&gt;&gt;() {}</span>
        );


<span class="nc" id="L69">        List&lt;CryptoCurrencyInfo&gt; cryptoCurrencyInfoList = null;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (response.getStatusCode() == HttpStatus.OK) {</span>
<span class="nc" id="L71">            cryptoCurrencyInfoList = response.getBody();</span>
        } else {
            // 处理错误
<span class="nc" id="L74">            return;</span>
        }

<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (!productMap.isEmpty()){</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            for(CryptoCurrencyInfo cryptoCurrencyInfo : cryptoCurrencyInfoList)</span>
            {
<span class="nc" id="L80">                Product product = productMap.get(cryptoCurrencyInfo.getName());</span>
<span class="nc" id="L81">                insertARecord(product);</span>
<span class="nc" id="L82">                double priceNew = cryptoCurrencyInfo.getPrice();</span>
<span class="nc" id="L83">                updateProductInfo(priceNew, product, cryptoCurrencyInfo.getTimestamp());</span>
<span class="nc" id="L84">                productMapper.updateById(product);</span>
<span class="nc" id="L85">                priceMap.put(product.getId(), product.getProductPrice());</span>
<span class="nc" id="L86">            }</span>
        }
        else
        {
<span class="nc bnc" id="L90" title="All 2 branches missed.">            for(CryptoCurrencyInfo cryptoCurrencyInfo : cryptoCurrencyInfoList)</span>
            {
<span class="nc" id="L92">                Product product = createProduct(cryptoCurrencyInfo);</span>
<span class="nc" id="L93">                productMap.put(product.getNameForUpdateAPI(), product);</span>
<span class="nc" id="L94">                productMapper.insert(product);</span>
<span class="nc" id="L95">                priceMap.put(product.getId(), product.getProductPrice());</span>
<span class="nc" id="L96">            }</span>
        }

<span class="nc" id="L99">        List&lt;PriceThreshold&gt; priceThresholdList = priceThresholdMapper.selectList(new QueryWrapper&lt;PriceThreshold&gt;()</span>
<span class="nc" id="L100">                .in(&quot;product_id&quot;, priceMap.keySet()));</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">        for(PriceThreshold priceThreshold : priceThresholdList)</span>
        {
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (priceThreshold.isMinimum()</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                    &amp;&amp; priceThreshold.getThreshold() &gt;= priceMap.get(priceThreshold.getProductId())</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                    &amp;&amp; !priceThreshold.isReached())</span>
            {
<span class="nc" id="L108">                priceThreshold.setReached(true);</span>
<span class="nc" id="L109">                priceThresholdMapper.updateById(priceThreshold);</span>
            }
<span class="nc bnc" id="L111" title="All 2 branches missed.">            else if (priceThreshold.isMinimum()</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    &amp;&amp; priceThreshold.getThreshold() &lt; priceMap.get(priceThreshold.getProductId())</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                    &amp;&amp; priceThreshold.isReached())</span>
            {
<span class="nc" id="L115">                priceThreshold.setReached(false);</span>
<span class="nc" id="L116">                priceThresholdMapper.updateById(priceThreshold);</span>
            }
<span class="nc bnc" id="L118" title="All 2 branches missed.">            else if (!priceThreshold.isMinimum()</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                    &amp;&amp; priceThreshold.getThreshold() &lt;= priceMap.get(priceThreshold.getProductId())</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                    &amp;&amp; !priceThreshold.isReached())</span>
            {
<span class="nc" id="L122">                priceThreshold.setReached(true);</span>
<span class="nc" id="L123">                priceThresholdMapper.updateById(priceThreshold);</span>
            }
<span class="nc bnc" id="L125" title="All 2 branches missed.">            else if (!priceThreshold.isMinimum()</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">                    &amp;&amp; priceThreshold.getThreshold() &lt; priceMap.get(priceThreshold.getProductId())</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                    &amp;&amp; priceThreshold.isReached())</span>
            {
<span class="nc" id="L129">                priceThreshold.setReached(false);</span>
<span class="nc" id="L130">                priceThresholdMapper.updateById(priceThreshold);</span>
            }
<span class="nc" id="L132">        }</span>
<span class="nc" id="L133">    }</span>

    private static Product createProduct(CryptoCurrencyInfo cryptoCurrencyInfo) {
<span class="nc" id="L136">        double priceNew = cryptoCurrencyInfo.getPrice();</span>
<span class="nc" id="L137">        Product product = new Product();</span>
<span class="nc" id="L138">        product.setCategory(CATEGORY.CRYPTOCURRENCY.getValue());</span>
<span class="nc" id="L139">        product.setCurrentTurnOfRecord(0);</span>
<span class="nc" id="L140">        product.setInResettingProcess(false);</span>
<span class="nc" id="L141">        product.setPriceStatus(2);</span>
<span class="nc" id="L142">        product.setProductCreateTime(cryptoCurrencyInfo.getTimestamp());</span>
<span class="nc" id="L143">        product.setProductDescription(&quot;This is &quot; + cryptoCurrencyInfo.getName());</span>
<span class="nc" id="L144">        product.setProductName(cryptoCurrencyInfo.getName());</span>
<span class="nc" id="L145">        product.setProductPrice(priceNew);</span>
<span class="nc" id="L146">        product.setProductUpdateTime(cryptoCurrencyInfo.getTimestamp());</span>
<span class="nc" id="L147">        product.setNameForUpdateAPI(cryptoCurrencyInfo.getName());</span>
<span class="nc" id="L148">        return product;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>